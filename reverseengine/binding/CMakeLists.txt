# ┌──────────────────────────────────────────────────────────────────┐
#   Setup pybind11
# └──────────────────────────────────────────────────────────────────┘
# yes, we will use submodule
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/pybind11/include)

# ┌──────────────────────────────────────────────────────────────────┐
#   TODO
# └──────────────────────────────────────────────────────────────────┘

find_package(PythonLibs 3 REQUIRED)
include_directories(${PYTHON_INCLUDE_DIRS})


# ┌──────────────────────────────────────────────────────────────────┐
#   Binding generated by pybind11
# └──────────────────────────────────────────────────────────────────┘
set(TARGET master)
set(BINDING_LIBRARY ${TARGET})
add_library(${TARGET} SHARED master.cc)
set_property(TARGET ${TARGET} PROPERTY CXX_STANDARD 20)
set_target_properties(${TARGET} PROPERTIES PREFIX "")
target_compile_options(${TARGET} PUBLIC
        -O1
        )
target_compile_definitions(${TARGET} PUBLIC
        -D_PYBIND11=1
        )
target_link_options(${TARGET} PUBLIC
        )
# FIXME[high]: pybind11 builds along with master.cc?
target_link_libraries(${TARGET}
        ${PROJECT_NAME}
        ${PYTHON_LIBRARIES}
        -lboost_iostreams
        )

# ┌──────────────────────────────────────────────────────────────────┐
#   setup.py
# └──────────────────────────────────────────────────────────────────┘
# Files to install with Python

set(PYTHON_INSTALL_FILES
        ${CMAKE_CURRENT_BINARY_DIR}/${BINDING_LIBRARY}.so # FIXME[medium]: can be .so or .dylib
        )

# Configure setup.py and copy to output directory
set(SETUP_PY_OUT ${CMAKE_CURRENT_BINARY_DIR}/setup.py)
configure_file(setup.py.in ${SETUP_PY_OUT})

# ┌──────────────────────────────────────────────────────────────────┐
#   Install
# └──────────────────────────────────────────────────────────────────┘
# Declare install target for python
# TODO: to remove????????
#install(TARGETS RE_WRAPPER_PYTHON
#        COMMAND "${PYTHON_EXECUTABLE} setup.py"
#        COMPONENT wrapper-python)


# Install target to call setup.py
add_custom_target(install_python_pybind11
        DEPENDS ${BINDING_LIBRARY}
        COMMAND python ${SETUP_PY_OUT} install)

# ┌──────────────────────────────────────────────────────────────────┐
#   TODO[meduim] pybind has very neat test module
# └──────────────────────────────────────────────────────────────────┘
add_test(NAME pybind11_test COMMAND "${PYTHON_EXECUTABLE} ${CMAKE_SOURCE_DIR}/reverseengine/test/pybind11/test.py")
